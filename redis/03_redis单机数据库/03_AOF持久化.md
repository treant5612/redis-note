### AOF持久化

除了RDB持久化之外，Redis还提供了AOF(APPEND ONLY FILE)持久化功能。AOF持久化是通过保存redis所有的写命令来记录数据库状态的。



#### AOF持久化的实现

AOF持久化功能的实现可以分为命令追加，文件写入，文件同步三个步骤。

- 命令追加：

  当AOF打开时，服务器在执行完写命令之后，会以**协议格式**将写命令追加到redisServer->aof_buf (sds)的末尾

  比如执行 SET KEY VALUE，会将以下协议内容追加到aof_buf的末尾：

  ``` 
  *3\r\n$3\r\nSET\r\n$3\r\nKEY\r\n$5\r\nVALUE\r\n
  ```

- AOF文件写入与同步

  redis的服务器进程就是一个事件循环，文件事件负责接收客户端命令并响应，时间时间则执行serverCron这样的需要定时运行的函数。在serverCron执行flushAppendOnlyFile (aof.c)函数。根据server.aof_fsync这个值，有如下3种策略

  > always：		将aof_buf缓冲区内的所有内容写入并同步到AOF文件
  >
  > everysec:		将aof_buf缓冲区的所有内容写入到AOF文件，如果上次同步时间超过1s，则进行同步。
  >
  > no:			   	将aof_buf缓冲区写入AOF文件，等待操作系统进行同步(sync) 	



#### AOF文件的载入与还原

由于AOF文件包含了重建数据库状态的所有操作日志，所以只需要读取并执行AOF的写命令，就可以还原状态。

详细步骤如下:

- 创建一个不带网络连接的fake client
- 从AOF文件中读取一条命令
- 使用fake client执行被读出的命令
- 重复读取命令/执行命令直到所有命令都被处理完毕为止。

#### AOF重写

随着时间推移，对于某个KEY，AOF中会包含对它许多修改命令，其效果与将KEY设置为最终值的一条命令是一样的。所以redis提供AOF重写功能以减小AOF文件体积。

其流程如下:

- 新建一个AOF文件（与原文件名不同）

- 遍历数据库，对非空数据库写入SELECT db命令，然后遍历其中的所有键
- 忽略已过期的键，根据键类型，调用相应函数将其作为命令写入
- 如果有过期时间，将过期时间设置也写入
- 关闭文件

对于集合/列表类型的数据，其重写可能不止一条命令。对SET而言，其元素超过REDIS_AOF_REWRITE_ITEMS_PER_CMD(64)时，就会使用多个SADD命令来记录，除最后一条外每个命令的元素数量均为64个。

#### 后台重写

aof_rewrite函数可以完成重写AOF文件的任务，但是大量IO会阻塞线程。所以像BGSAVE一样，redis使用fork子进程来执行AOF重写。（如果正在执行BGSAVE/SAVE，会使AOF重写延后进行）。

由于进程间数据不一致的问题，在重写过程中，主进程会将这段时间的命令同时写入到AOF缓冲区和AOF重写缓冲区，AOF缓冲区的内容会照常写入到现有AOF文件，而AOF重写缓冲区中的内容，会在重写子进程完成之后，写入到新的AOF文件末尾。

之后再将新的AOF文件改名，原子地覆盖现有AOF文件，完成AOF文件替换。